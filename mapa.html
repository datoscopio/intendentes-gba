<!DOCTYPE html>
<meta charset="utf-8">
<script src='https://cdnjs.cloudflare.com/ajax/libs/d3/3.5.6/d3.min.js'></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/queue-async/1.0.7/queue.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/topojson/1.6.19/topojson.min.js"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jquery/2.1.4/jquery.min.js"></script>
<script src="js/d3.geo.tile.min.js"></script>
<style type="text/css">

body {
	padding: 0;
	margin: 0px;
	overflow: hidden;
}

svg {
  border: 1px solid black;
}

.key path {
  display: none;
}

.key line {
  stroke: #000;
  shape-rendering: crispEdges;
}
.key {
  fill-opacity: .8;
}

.departamento {
  fill: #eee;
  fill-opacity: .6;
  stroke: #aaa;
}


.departamentos {
  fill: none;
  stroke: red;
  stroke-linejoin: round;
}

</style>
<body>

<script>

var width = Math.max(960, window.innerWidth),
    height = Math.max(500, window.innerHeight)
    active = d3.select(null);


var color = d3.scale.threshold()
  .domain([2, 6, 10, 16, 20, 24])
  .range(["#ffffff", "#d2d1fd", "#a5a3fb", "#7774f9", "#4a46f7", "#0000ff"]);

var x = d3.scale.linear()
    .domain([0, 27])
    .range([0, 240]);

var xAxis = d3.svg.axis()
    .scale(x)
    .orient("bottom")
    .tickSize(13)
    .tickValues(color.domain());

var tile = d3.geo.tile()
    .size([width, height]);

// var projection = d3.geo.mercator()
//     .scale((1 << 12) / 2 / Math.PI)
//     .translate([width / 2, height / 2]);

var projection = d3.geo.mercator()
    .scale((1 << 17) / 2 / Math.PI)
    .translate([width / 2, height / 2]);

var center = projection([-58.5,-34.5]);

var path = d3.geo.path()
    .projection(projection);

var zoom = d3.behavior.zoom()
    .scale(projection.scale() * 2 * Math.PI)
    .scaleExtent([1 << 17, 1 << 20])
    .translate([width - center[0], height - center[1]])
    .on("zoom", zoomed);

var svg = d3.select("body").append("svg")
    .attr("width", width)
    .attr("height", height);     

var raster = svg.append("g");

var departamentos, tiles;

queue()
    .defer(d3.json, "gba.json")
    .defer(d3.json, "data/actuales.json")
    .await(ready);

function ready(error, gba,actuales) {
	if (error) throw error;
	 console.table(gba.objects.poligonos_gba)
	svg.call(zoom);
	tiles = tile
		.scale(zoom.scale())
		.translate(zoom.translate())();

	projection
	  .scale(zoom.scale() / 2 / Math.PI)
	  .translate(zoom.translate());

	departamentos = topojson.feature(gba, gba.objects.poligonos_gba)

	departamentos = svg.selectAll("path")
		  .data(departamentos.features)
	    .enter()
		  .append("path")
		  .attr("class", "departamento")
		  .attr("d", path)
		  .on("click", clicked);
	svg.selectAll(".departamento")
    .style("fill", function(d) {
      return color(+d.properties.anos_en_el_cargo);
    })

	zoomed();

var key = svg.append("g");
	key.attr("class", "key")
	    .attr("transform", "translate(80, 80)");
		
	key.append("rect")
		.attr("x",-8).attr("y",-15)
		.attr("width",255).attr("height",42)
		.style("fill-opacity", 1).style("fill", "white");
		
	key.selectAll("rect")
	    .data(color.range().map(function(d, i) {
	      return {
	        x0: i ? x(color.domain()[i - 1]) : x.range()[0],
	        x1: i < color.domain().length ? x(color.domain()[i]) : x.range()[1],
	        z: d
	      };
	    }))
	  .enter().append("rect")
	    .attr("height", 8)
	    .attr("x", function(d) { return d.x0; })
	    .attr("width", function(d) { return d.x1 - d.x0; })
	    .style("fill", function(d) { return d.z; });

	key.call(xAxis).append("text")
	    .attr("class", "caption")
	    .attr("y", -6)
	    .text("Intendentes de GBA, cantidad de aÃ±os en el cargo");
}     

function zoomed() {
  //svg.call(zoom);

  tiles = tile
    .scale(zoom.scale())
    .translate(zoom.translate())();

  projection
    .scale(zoom.scale() / 2 / Math.PI)
    .translate(zoom.translate());

  departamentos.attr("d", path);

  svg.attr("transform", "translate(" + zoom.translate() + ")scale(" + zoom.scale() + ")");

  var image = raster
    .attr("transform", "scale(" + tiles.scale + ")translate(" + tiles.translate + ")")
    .selectAll("image")
    .data(tiles, function(d) { return d;  });

  image.exit().remove();

  image.enter().append("image")
    .attr("xlink:href", function(d) {
      return "http://" + ["a", "b", "c", "d"][Math.random() * 4 | 0] + ".tile.stamen.com/toner-lite/" + d[2] + "/" + d[0] + "/" + d[1] + ".png";
    })
    .attr("width", 1)
    .attr("height", 1)
    .attr("x", function(d) {
      return d[0];
    })
    .attr("y", function(d) {
      return d[1];
    });
}

function clicked(d) {
  if (active.node() === this) return reset();
  active.classed("active", false);
  active = d3.select(this).classed("active", true);

  var bounds = path.bounds(d),
      dx = bounds[1][0] - bounds[0][0],
      dy = bounds[1][1] - bounds[0][1],
      x = (bounds[0][0] + bounds[1][0]) / 2,
      y = (bounds[0][1] + bounds[1][1]) / 2,
      scale = .9 / Math.max(dx / width, dy / height),
      translate = [width / 2 - scale * x, height / 2 - scale * y];

  svg.transition()
      .duration(750)
      .call(zoom.translate(translate).scale(scale).event);
}

function reset() {
  active.classed("active", false);
  active = d3.select(null);

  svg.transition()
      .duration(750)
      .call(zoom.translate([0, 0]).scale(1).event);
}

function stopped() {
  if (d3.event.defaultPrevented) d3.event.stopPropagation();
}

</script>
</body>
</html>